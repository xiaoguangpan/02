name: Android CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ç¼“å­˜ Gradle ä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
      run: chmod +x gradlew
      
    - name: æ„å»º Debug APK
      run: ./gradlew assembleDebug
      
    - name: æ„å»º Release APK
      run: ./gradlew assembleRelease
      
    - name: ç”Ÿæˆç­¾åä¿¡æ¯
      run: |
        echo "=== å®šçº¢å®šä½æ¨¡æ‹Ÿå™¨æ„å»ºä¿¡æ¯ ===" > build-info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> build-info.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> build-info.txt
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== åº”ç”¨ä¿¡æ¯ ===" >> build-info.txt
        echo "åº”ç”¨åç§°: å®šçº¢å®šä½æ¨¡æ‹Ÿå™¨" >> build-info.txt
        echo "åŒ…å: com.dinghong.locationmock" >> build-info.txt
        echo "ç‰ˆæœ¬: 2.0" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== Debugç‰ˆæœ¬SHA1 ===" >> build-info.txt
        keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android | grep SHA1 >> build-info.txt || echo "æ— æ³•è·å–Debug SHA1" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== ç™¾åº¦åœ°å›¾SDKé…ç½®è¯´æ˜ ===" >> build-info.txt
        echo "è¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯åœ¨ç™¾åº¦åœ°å›¾å¼€æ”¾å¹³å°ç”³è¯·API Key:" >> build-info.txt
        echo "åŒ…å(PackageName): com.dinghong.locationmock" >> build-info.txt
        echo "SHA1: è¯·æŸ¥çœ‹ä¸Šæ–¹Debugç‰ˆæœ¬SHA1ä¿¡æ¯" >> build-info.txt
        echo "ç”³è¯·åœ°å€: https://lbsyun.baidu.com/apiconsole/key" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== æ–‡ä»¶ä¿¡æ¯ ===" >> build-info.txt
        ls -la app/build/outputs/apk/debug/ >> build-info.txt
        ls -la app/build/outputs/apk/release/ >> build-info.txt
        
    - name: é‡å‘½åAPKæ–‡ä»¶
      run: |
        mkdir -p release-files
        cp app/build/outputs/apk/debug/app-debug.apk release-files/dinghong-debug-v2.0.apk
        cp app/build/outputs/apk/release/app-release-unsigned.apk release-files/dinghong-release-v2.0-unsigned.apk
        cp build-info.txt release-files/
        
    - name: ä¸Šä¼ Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: dinghong-debug-apk
        path: release-files/dinghong-debug-v2.0.apk
        
    - name: ä¸Šä¼ Release APK
      uses: actions/upload-artifact@v4
      with:
        name: dinghong-release-apk
        path: release-files/dinghong-release-v2.0-unsigned.apk
        
    - name: ä¸Šä¼ æ„å»ºä¿¡æ¯
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: release-files/build-info.txt
        
    - name: è¾“å‡ºæ„å»ºç»“æœ
      run: |
        echo "ğŸ‰ å®šçº¢å®šä½æ¨¡æ‹Ÿå™¨æ„å»ºå®Œæˆ!"
        echo ""
        echo "ğŸ“± åº”ç”¨ä¿¡æ¯:"
        echo "  - åº”ç”¨åç§°: å®šçº¢å®šä½æ¨¡æ‹Ÿå™¨"
        echo "  - åŒ…å: com.dinghong.locationmock"
        echo "  - ç‰ˆæœ¬: 2.0"
        echo ""
        echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
        echo "  - Debug APK: dinghong-debug-v2.0.apk"
        echo "  - Release APK: dinghong-release-v2.0-unsigned.apk"
        echo "  - æ„å»ºä¿¡æ¯: build-info.txt"
        echo ""
        echo "ğŸ”‘ ç™¾åº¦åœ°å›¾SDKé…ç½®:"
        echo "  1. è®¿é—®: https://lbsyun.baidu.com/apiconsole/key"
        echo "  2. åˆ›å»ºåº”ç”¨ï¼Œé€‰æ‹©Androidå¹³å°"
        echo "  3. è¾“å…¥åŒ…å: com.dinghong.locationmock"
        echo "  4. è¾“å…¥SHA1: è¯·æŸ¥çœ‹build-info.txtæ–‡ä»¶"
        echo "  5. å°†è·å¾—çš„API Keyæ›¿æ¢AndroidManifest.xmlä¸­çš„YOUR_BAIDU_MAP_API_KEY"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²ä¸Šä¼ åˆ°GitHub Actions Artifacts"
        
  # å‘å¸ƒåˆ°Releaseï¼ˆä»…åœ¨åˆ›å»ºReleaseæ—¶è§¦å‘ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: ä¸Šä¼ åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/dinghong-debug-apk/dinghong-debug-v2.0.apk
          artifacts/dinghong-release-apk/dinghong-release-v2.0-unsigned.apk
          artifacts/build-info/build-info.txt
        body: |
          ## å®šçº¢å®šä½æ¨¡æ‹Ÿå™¨ v2.0
          
          ### ğŸš€ æ–°åŠŸèƒ½ç‰¹æ€§
          - âœ¨ å…¨æ–°Material Design 3ç•Œé¢è®¾è®¡
          - ğŸ—ºï¸ é›†æˆç™¾åº¦åœ°å›¾SDKï¼Œæ”¯æŒå«æ˜Ÿåœ°å›¾æ˜¾ç¤º
          - ğŸ¯ æ™ºèƒ½ä½ç½®æ¨¡æ‹Ÿç³»ç»Ÿï¼ˆæ ‡å‡†æ¨¡å¼ + å¢å¼ºæ¨¡å¼ï¼‰
          - ğŸ” æ™ºèƒ½åœ°å€æœç´¢å’Œåæ ‡è¾“å…¥è¯†åˆ«
          - ğŸ› ï¸ ä¸“ä¸šè°ƒè¯•é¢æ¿ï¼Œå®æ—¶çŠ¶æ€ç›‘æ§
          - ğŸ“± é€‚é…Android 6.0 - 14.0å…¨ç‰ˆæœ¬
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¹¶å®‰è£…APKæ–‡ä»¶
          2. åœ¨å¼€å‘è€…é€‰é¡¹ä¸­å¯ç”¨"æ¨¡æ‹Ÿä½ç½®ä¿¡æ¯åº”ç”¨"
          3. ç”³è¯·ç™¾åº¦åœ°å›¾API Keyå¹¶é…ç½®åˆ°åº”ç”¨ä¸­
          4. æˆäºˆä½ç½®æƒé™åå³å¯ä½¿ç”¨
          
          ### ğŸ”‘ ç™¾åº¦åœ°å›¾API Keyé…ç½®
          - åŒ…å: `com.dinghong.locationmock`
          - SHA1: è¯·æŸ¥çœ‹build-info.txtæ–‡ä»¶
          - ç”³è¯·åœ°å€: https://lbsyun.baidu.com/apiconsole/key
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - `dinghong-debug-v2.0.apk`: è°ƒè¯•ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - `dinghong-release-v2.0-unsigned.apk`: å‘å¸ƒç‰ˆæœ¬ï¼ˆæœªç­¾åï¼‰
          - `build-info.txt`: æ„å»ºä¿¡æ¯å’Œé…ç½®è¯´æ˜
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
