name: Android CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ç¼“å­˜ Gradle ä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: è®¾ç½® Gradle Wrapper
      run: |
        # ä¸‹è½½ gradle-wrapper.jar
        mkdir -p gradle/wrapper
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.0.0/gradle/wrapper/gradle-wrapper.jar

        # æˆäºˆæ‰§è¡Œæƒé™
        chmod +x gradlew

    - name: éªŒè¯ Gradle è®¾ç½®
      run: ./gradlew --version

    - name: åˆ›å»ºDebug Keystore
      run: |
        # ç¡®ä¿debug.keystoreå­˜åœ¨
        mkdir -p ~/.android
        if [ ! -f ~/.android/debug.keystore ]; then
          echo "åˆ›å»ºdebug.keystoreç”¨äºAPKç­¾å..."
          keytool -genkey -v -keystore ~/.android/debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "Debug keystoreåˆ›å»ºå®Œæˆ"
        else
          echo "Debug keystoreå·²å­˜åœ¨"
        fi

        # éªŒè¯keystore
        echo "éªŒè¯keystoreä¿¡æ¯:"
        keytool -list -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey

    - name: è¾“å‡ºæ„å»ºä¿¡æ¯ (ç¼–è¯‘å‰)
      run: |
        echo "=== redingå®šä½æ¨¡æ‹Ÿå™¨æ„å»ºä¿¡æ¯ ==="
        echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Gitæäº¤: $(git rev-parse --short HEAD)"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo ""
        echo "=== åº”ç”¨ä¿¡æ¯ ==="
        echo "åº”ç”¨åç§°: redingå®šä½æ¨¡æ‹Ÿå™¨"
        echo "åŒ…å(PackageName): com.dinghong.locationmock"
        echo "ç‰ˆæœ¬: 2.0"
        echo ""
        echo "=== Debugç‰ˆæœ¬SHA1 (ç”¨äºå¼€å‘æµ‹è¯•) ==="

        # ç¡®ä¿debug.keystoreå­˜åœ¨
        if [ ! -f ~/.android/debug.keystore ]; then
          echo "åˆ›å»ºdebug.keystore..."
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        fi

        # è·å–å®Œæ•´SHA1å¹¶ç›´æ¥æ˜¾ç¤º
        echo "Debug keystoreè·¯å¾„: ~/.android/debug.keystore"
        echo ""
        echo "ğŸ”‘ å®Œæ•´SHA1ç­¾å (ç”¨äºç™¾åº¦åœ°å›¾APIç”³è¯·):"
        SHA1_VALUE=$(keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android 2>/dev/null | grep "SHA1:" | head -1 | sed 's/.*SHA1: //' | tr -d ' ')
        echo "SHA1: $SHA1_VALUE"
        echo ""
        echo "ğŸ“‹ å¤åˆ¶ä¸Šé¢çš„SHA1å€¼ç”¨äºç™¾åº¦åœ°å›¾APIç”³è¯·"
        echo ""
        echo "=== ç™¾åº¦åœ°å›¾SDKé…ç½®è¯´æ˜ ==="
        echo "1. è®¿é—®ç™¾åº¦åœ°å›¾å¼€æ”¾å¹³å°: https://lbsyun.baidu.com/apiconsole/key"
        echo "2. ç‚¹å‡»ã€åˆ›å»ºåº”ç”¨ã€‘"
        echo "3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯:"
        echo "   - åº”ç”¨åç§°: redingå®šä½æ¨¡æ‹Ÿå™¨"
        echo "   - åº”ç”¨ç±»å‹: é€‰æ‹©ã€Android SDKã€‘"
        echo "   - åŒ…å: com.dinghong.locationmock"
        echo "   - SHA1: $SHA1_VALUE"
        echo "4. è·å–API Keyåï¼Œæ›¿æ¢AndroidManifest.xmlä¸­çš„YOUR_BAIDU_MAP_API_KEY"
        echo ""

    - name: æ„å»º Debug APK
      run: |
        echo "=== å¼€å§‹æ„å»ºDebug APK ==="
        ./gradlew assembleDebug --stacktrace

    - name: æ„å»º Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: ç”Ÿæˆç­¾åä¿¡æ¯å’ŒSHA1
      run: |
        echo "=== redingå®šä½æ¨¡æ‹Ÿå™¨æ„å»ºä¿¡æ¯ ===" > build-info.txt
        echo "æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> build-info.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> build-info.txt
        echo "åˆ†æ”¯: ${{ github.ref_name }}" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== åº”ç”¨ä¿¡æ¯ ===" >> build-info.txt
        echo "åº”ç”¨åç§°: redingå®šä½æ¨¡æ‹Ÿå™¨" >> build-info.txt
        echo "åŒ…å(PackageName): com.dinghong.locationmock" >> build-info.txt
        echo "ç‰ˆæœ¬: 2.0" >> build-info.txt
        echo "" >> build-info.txt

        # è·å–Debugç‰ˆæœ¬SHA1ï¼ˆç”¨äºæ–‡ä»¶è®°å½•ï¼‰
        echo "=== Debugç‰ˆæœ¬SHA1 (ç”¨äºå¼€å‘å’Œæµ‹è¯•) ===" >> build-info.txt
        DEBUG_SHA1=$(keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android 2>/dev/null | grep "SHA1:" | head -1 | sed 's/.*SHA1: //' | tr -d ' ')
        echo "Debug SHA1: $DEBUG_SHA1" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== ç™¾åº¦åœ°å›¾SDKé…ç½®è¯´æ˜ ===" >> build-info.txt
        echo "1. è®¿é—®ç™¾åº¦åœ°å›¾å¼€æ”¾å¹³å°: https://lbsyun.baidu.com/apiconsole/key" >> build-info.txt
        echo "2. ç‚¹å‡»ã€åˆ›å»ºåº”ç”¨ã€‘" >> build-info.txt
        echo "3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯:" >> build-info.txt
        echo "   - åº”ç”¨åç§°: redingå®šä½æ¨¡æ‹Ÿå™¨" >> build-info.txt
        echo "   - åº”ç”¨ç±»å‹: é€‰æ‹©ã€Android SDKã€‘" >> build-info.txt
        echo "   - åŒ…å: com.dinghong.locationmock" >> build-info.txt
        echo "   - SHA1: $DEBUG_SHA1" >> build-info.txt
        echo "4. è·å–API Keyåï¼Œæ›¿æ¢AndroidManifest.xmlä¸­çš„YOUR_BAIDU_MAP_API_KEY" >> build-info.txt
        echo "" >> build-info.txt
        echo "=== æ„å»ºäº§ç‰©ä¿¡æ¯ ===" >> build-info.txt
        if [ -d "app/build/outputs/apk/debug/" ]; then
          ls -la app/build/outputs/apk/debug/ >> build-info.txt
        fi
        if [ -d "app/build/outputs/apk/release/" ]; then
          ls -la app/build/outputs/apk/release/ >> build-info.txt
        fi
        
    - name: é‡å‘½åAPKæ–‡ä»¶
      run: |
        mkdir -p release-files

        # æ£€æŸ¥APKæ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶å¤åˆ¶
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp app/build/outputs/apk/debug/app-debug.apk release-files/reding-debug.apk
          echo "âœ… Debug APKå·²å¤åˆ¶: reding-debug.apk"
        else
          echo "âŒ Debug APKæ–‡ä»¶ä¸å­˜åœ¨"
          find app/build/outputs/apk/debug/ -name "*.apk" || echo "Debugç›®å½•ä¸ºç©º"
        fi

        # Release APKç°åœ¨åº”è¯¥æ˜¯ç­¾åçš„ï¼Œæ–‡ä»¶åä¸ºapp-release.apk
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          cp app/build/outputs/apk/release/app-release.apk release-files/reding-release.apk
          echo "âœ… Release APKå·²å¤åˆ¶: reding-release.apk (å·²ç­¾å)"
        elif [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          cp app/build/outputs/apk/release/app-release-unsigned.apk release-files/reding-release.apk
          echo "âš ï¸ Release APKå·²å¤åˆ¶: reding-release.apk (æœªç­¾åç‰ˆæœ¬)"
        else
          echo "âŒ Release APKæ–‡ä»¶ä¸å­˜åœ¨"
          find app/build/outputs/apk/release/ -name "*.apk" || echo "Releaseç›®å½•ä¸ºç©º"
        fi

        cp build-info.txt release-files/

        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶
        echo "ğŸ“¦ æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la release-files/

    - name: éªŒè¯APKç­¾å
      run: |
        echo "=== éªŒè¯APKç­¾åä¿¡æ¯ ==="

        if [ -f "release-files/reding-debug.apk" ]; then
          echo "ğŸ” Debug APKåŸºæœ¬ä¿¡æ¯:"
          file release-files/reding-debug.apk
          ls -la release-files/reding-debug.apk

          # ä½¿ç”¨unzipæ£€æŸ¥APKå†…å®¹
          echo "ğŸ“¦ APKå†…å®¹æ£€æŸ¥:"
          unzip -l release-files/reding-debug.apk | grep -E "(META-INF|AndroidManifest)" | head -10

          # æ£€æŸ¥ç­¾åæ–‡ä»¶
          echo "ğŸ” ç­¾åæ–‡ä»¶æ£€æŸ¥:"
          unzip -l release-files/reding-debug.apk | grep "META-INF.*\.(RSA\|DSA\|SF\|MF)" || echo "æœªæ‰¾åˆ°ç­¾åæ–‡ä»¶"

          # ä½¿ç”¨jarsigneréªŒè¯ç­¾åï¼ˆJavaå·¥å…·ï¼Œåº”è¯¥å¯ç”¨ï¼‰
          if command -v jarsigner &> /dev/null; then
            echo "ğŸ” ä½¿ç”¨jarsigneréªŒè¯ç­¾å:"
            jarsigner -verify -verbose release-files/reding-debug.apk && echo "âœ… Debug APKç­¾åæœ‰æ•ˆ" || echo "âŒ Debug APKç­¾åæ— æ•ˆ"
          fi
        fi

        if [ -f "release-files/reding-release.apk" ]; then
          echo "ğŸ” Release APKåŸºæœ¬ä¿¡æ¯:"
          file release-files/reding-release.apk
          ls -la release-files/reding-release.apk

          # ä½¿ç”¨unzipæ£€æŸ¥APKå†…å®¹
          echo "ğŸ“¦ APKå†…å®¹æ£€æŸ¥:"
          unzip -l release-files/reding-release.apk | grep -E "(META-INF|AndroidManifest)" | head -10

          # æ£€æŸ¥ç­¾åæ–‡ä»¶
          echo "ğŸ” ç­¾åæ–‡ä»¶æ£€æŸ¥:"
          unzip -l release-files/reding-release.apk | grep "META-INF.*\.(RSA\|DSA\|SF\|MF)" || echo "æœªæ‰¾åˆ°ç­¾åæ–‡ä»¶"

          # ä½¿ç”¨jarsigneréªŒè¯ç­¾å
          if command -v jarsigner &> /dev/null; then
            echo "ğŸ” ä½¿ç”¨jarsigneréªŒè¯ç­¾å:"
            jarsigner -verify -verbose release-files/reding-release.apk && echo "âœ… Release APKç­¾åæœ‰æ•ˆ" || echo "âŒ Release APKç­¾åæ— æ•ˆ"
          fi
        fi

    - name: ä¸Šä¼ Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: reding-debug-apk
        path: release-files/reding-debug.apk

    - name: ä¸Šä¼ Release APK
      uses: actions/upload-artifact@v4
      with:
        name: reding-release-apk
        path: release-files/reding-release.apk
        
    - name: ä¸Šä¼ æ„å»ºä¿¡æ¯
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: release-files/build-info.txt
        
    - name: è¾“å‡ºæ„å»ºç»“æœ
      run: |
        echo "ğŸ‰ redingå®šä½æ¨¡æ‹Ÿå™¨æ„å»ºå®Œæˆ!"
        echo ""
        echo "ğŸ“± åº”ç”¨ä¿¡æ¯:"
        echo "  - åº”ç”¨åç§°: redingå®šä½æ¨¡æ‹Ÿå™¨"
        echo "  - åŒ…å: com.dinghong.locationmock"
        echo "  - ç‰ˆæœ¬: 2.0"
        echo ""
        echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
        echo "  - Debug APK: reding-debug.apk (å·²ç­¾åï¼Œå¯ç›´æ¥å®‰è£…)"
        echo "  - Release APK: reding-release.apk (å·²ç­¾åï¼Œå¯ç›´æ¥å®‰è£…)"
        echo "  - æ„å»ºä¿¡æ¯: build-info.txt"
        echo ""
        echo "ğŸ”‘ ç™¾åº¦åœ°å›¾SDKé…ç½®:"
        echo "  1. è®¿é—®: https://lbsyun.baidu.com/apiconsole/key"
        echo "  2. åˆ›å»ºåº”ç”¨ï¼Œé€‰æ‹©ã€Android SDKã€‘"
        echo "  3. è¾“å…¥åŒ…å: com.dinghong.locationmock"
        echo "  4. è¾“å…¥SHA1: è¯·æŸ¥çœ‹build-info.txtæ–‡ä»¶ä¸­çš„Debug SHA1"
        echo "  5. å°†è·å¾—çš„API Keyæ›¿æ¢AndroidManifest.xmlä¸­çš„YOUR_BAIDU_MAP_API_KEY"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²ä¸Šä¼ åˆ°GitHub Actions Artifacts"
        
  # å‘å¸ƒåˆ°Releaseï¼ˆä»…åœ¨åˆ›å»ºReleaseæ—¶è§¦å‘ï¼‰
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: ä¸Šä¼ åˆ°Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/reding-debug-apk/reding-debug.apk
          artifacts/reding-release-apk/reding-release.apk
          artifacts/build-info/build-info.txt
        body: |
          ## redingå®šä½æ¨¡æ‹Ÿå™¨ v2.0
          
          ### ğŸš€ æ–°åŠŸèƒ½ç‰¹æ€§
          - âœ¨ å…¨æ–°Material Design 3ç•Œé¢è®¾è®¡
          - ğŸ—ºï¸ é›†æˆç™¾åº¦åœ°å›¾SDKï¼Œæ”¯æŒå«æ˜Ÿåœ°å›¾æ˜¾ç¤º
          - ğŸ¯ æ™ºèƒ½ä½ç½®æ¨¡æ‹Ÿç³»ç»Ÿï¼ˆæ ‡å‡†æ¨¡å¼ + å¢å¼ºæ¨¡å¼ï¼‰
          - ğŸ” æ™ºèƒ½åœ°å€æœç´¢å’Œåæ ‡è¾“å…¥è¯†åˆ«
          - ğŸ› ï¸ ä¸“ä¸šè°ƒè¯•é¢æ¿ï¼Œå®æ—¶çŠ¶æ€ç›‘æ§
          - ğŸ“± é€‚é…Android 6.0 - 14.0å…¨ç‰ˆæœ¬
          
          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¹¶å®‰è£…APKæ–‡ä»¶
          2. åœ¨å¼€å‘è€…é€‰é¡¹ä¸­å¯ç”¨"æ¨¡æ‹Ÿä½ç½®ä¿¡æ¯åº”ç”¨"
          3. ç”³è¯·ç™¾åº¦åœ°å›¾API Keyå¹¶é…ç½®åˆ°åº”ç”¨ä¸­
          4. æˆäºˆä½ç½®æƒé™åå³å¯ä½¿ç”¨
          
          ### ğŸ”‘ ç™¾åº¦åœ°å›¾API Keyé…ç½®
          - åŒ…å: `com.dinghong.locationmock`
          - SHA1: è¯·æŸ¥çœ‹build-info.txtæ–‡ä»¶
          - ç”³è¯·åœ°å€: https://lbsyun.baidu.com/apiconsole/key
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - `reding-debug.apk`: è°ƒè¯•ç‰ˆæœ¬ï¼ˆå·²ç­¾åï¼Œå¯ç›´æ¥å®‰è£…ï¼‰
          - `reding-release.apk`: å‘å¸ƒç‰ˆæœ¬ï¼ˆå·²ç­¾åï¼Œå¯ç›´æ¥å®‰è£…ï¼‰
          - `build-info.txt`: æ„å»ºä¿¡æ¯å’Œé…ç½®è¯´æ˜

          ### ğŸ”§ å®‰è£…è¯´æ˜
          ä¸¤ä¸ªAPKæ–‡ä»¶éƒ½å·²ä½¿ç”¨debug keystoreç­¾åï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š
          - é€šè¿‡ADB: `adb install reding-debug.apk` æˆ– `adb install reding-release.apk`
          - ç›´æ¥åœ¨è®¾å¤‡ä¸Šå®‰è£…ï¼ˆéœ€è¦å…è®¸æœªçŸ¥æ¥æºï¼‰
          - ä¸ä¼šå‡ºç°è¯ä¹¦é”™è¯¯
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
